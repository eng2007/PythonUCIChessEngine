# Шахматный движок с поддержкой UCI

Полнофункциональный шахматный движок на Python с поддержкой протокола UCI (Universal Chess Interface) и реализацией всех правил FIDE.

## Возможности

### Реализованные правила шахмат (FIDE)
- ✅ Все виды ходов фигур (пешка, конь, слон, ладья, ферзь, король)
- ✅ Рокировка (короткая и длинная)
- ✅ Взятие на проходе (en passant)
- ✅ Превращение пешки (во все фигуры)
- ✅ Шах, мат, пат
- ✅ Правило 50 ходов
- ✅ Троекратное повторение позиции
- ✅ Недостаточность материала для мата

### Протокол UCI
- ✅ Команды: `uci`, `isready`, `ucinewgame`, `position`, `go`, `stop`, `quit`
- ✅ FEN нотация для позиций
- ✅ Вывод хода в формате UCI (e2e4, e7e5, e7e8q)
- ✅ Параметры поиска (глубина, время)

### Движок поиска
- ✅ Алгоритм Minimax с альфа-бета отсечением
- ✅ Quiescence search для избежания горизонт-эффекта
- ✅ Оценочная функция с материалом и позиционными таблицами
- ✅ Настраиваемая глубина поиска
- ✅ Упорядочивание ходов (MVV-LVA для взятий)

## Структура проекта

```
chess_engine/
├── chess_engine.py      # Главный файл запуска
├── chess_board.py       # Представление доски и ходов
├── move_generator.py    # Генерация и валидация ходов
├── search_engine.py     # Поисковый движок (Minimax + Alpha-Beta)
├── uci_interface.py     # UCI протокол
└── README.md           # Документация
```

## Установка и запуск

### Требования
- Python 3.8+
- Никаких внешних библиотек не требуется

### Запуск

#### 1. UCI режим (для подключения к GUI)
```bash
python chess_engine.py
```

После запуска движок ожидает UCI команды через stdin.

#### 2. Тестовый режим
```bash
python chess_engine.py --test
```

Запускает набор тестов для проверки функциональности.

#### 3. Интерактивная игра
```bash
python chess_engine.py --game
```

Играйте против движка в консоли. Вводите ходы в UCI формате (например, `e2e4`).

## Использование UCI

### Основные команды

```bash
# Инициализация
uci                    # Получить информацию о движке
isready                # Проверка готовности
ucinewgame            # Начать новую игру

# Установка позиции
position startpos                           # Начальная позиция
position startpos moves e2e4 e7e5          # С ходами
position fen <FEN>                          # Из FEN нотации

# Поиск хода
go depth 5                                  # Поиск на глубину 5
go movetime 5000                           # Поиск 5 секунд
go wtime 60000 btime 60000                 # С контролем времени
go infinite                                # Бесконечный поиск

# Управление
stop                   # Остановить поиск
quit                   # Выход
```

### Пример сессии

```
> uci
id name ChessEngine
id author AI Chess Developer
uciok

> isready
readyok

> position startpos moves e2e4
> go depth 4
bestmove e7e5

> quit
```

## Подключение к GUI

Движок совместим с любыми UCI-совместимыми шахматными GUI, такими как:
- Arena Chess GUI
- Cute Chess
- ChessBase
- BanksiaGUI

### Настройка в Arena Chess:
1. Engines → Install New Engine
2. Выберите `chess_engine.py`
3. Установите тип: UCI

## Архитектура

### ChessBoard (`chess_board.py`)
Класс для представления шахматной доски:
- Хранение позиции (8x8 массив)
- FEN нотация (чтение/запись)
- Права на рокировку
- En passant квадрат
- Счетчики ходов
- История позиций

### Move
Класс для представления хода:
- Начальная и конечная позиции
- Тип хода (обычный, рокировка, en passant, превращение)
- Взятие фигуры
- UCI формат

### MoveGenerator (`move_generator.py`)
Генерация и валидация ходов:
- Генерация псевдо-легальных ходов для всех фигур
- Проверка легальности (не оставляет короля под шахом)
- Проверка атакованных полей
- Определение шаха, мата, пата
- Проверка правил ничьей

### SearchEngine (`search_engine.py`)
Поиск лучшего хода:
- Minimax алгоритм с альфа-бета отсечением
- Quiescence search для тактической точности
- Оценочная функция:
  - Материал (стоимость фигур)
  - Позиционные таблицы (piece-square tables)
  - Мобильность
- Упорядочивание ходов (move ordering)
- Контроль времени

### UCIInterface (`uci_interface.py`)
UCI протокол:
- Парсинг UCI команд
- Управление позицией
- Запуск поиска
- Форматирование вывода

## Оценочная функция

Движок использует следующие критерии для оценки позиции:

### Материал
- Пешка: 100
- Конь: 320
- Слон: 330
- Ладья: 500
- Ферзь: 900
- Король: 20000

### Позиционные бонусы
Использует piece-square tables для оценки позиции фигур:
- Пешки: бонус за продвижение вперед и контроль центра
- Кони: бонус за центральные позиции
- Слоны: бонус за диагонали и центр
- Ладьи: бонус за открытые линии
- Ферзь: универсальная позиция
- Король: безопасность (края доски в миттельшпиле)

### Мобильность
- Дополнительные очки за количество доступных ходов

## Производительность

Типичная производительность на глубине 4:
- Начальная позиция: ~5,000-10,000 узлов
- Сложная миттельшпиль: ~20,000-50,000 узлов
- Эндшпиль: ~1,000-5,000 узлов

Время поиска зависит от позиции и настроек.

## Тестирование

Запустите тестовый режим для проверки всех компонентов:

```bash
python chess_engine.py --test
```

Тесты проверяют:
1. Инициализацию доски
2. Генерацию ходов
3. Выполнение ходов
4. Определение мата
5. Поиск лучшего хода
6. Рокировку
7. Взятие на проходе
8. Превращение пешки

## Примеры использования

### Анализ позиции

```python
from chess_board import ChessBoard
from move_generator import MoveGenerator
from search_engine import SearchEngine

# Загрузка позиции
board = ChessBoard()
board.load_fen("rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1")

# Генерация ходов
move_gen = MoveGenerator(board)
legal_moves = move_gen.generate_legal_moves()

print(f"Legal moves: {len(legal_moves)}")
for move in legal_moves:
    print(move.to_uci(board))

# Поиск лучшего хода
engine = SearchEngine()
best_move = engine.search(board, depth=5)
print(f"Best move: {best_move.to_uci(board)}")
```

### Проверка правил

```python
from chess_board import ChessBoard
from move_generator import MoveGenerator

# Мат
board = ChessBoard()
board.load_fen("rnb1kbnr/pppp1ppp/8/4p3/6Pq/5P2/PPPPP2P/RNBQKBNR w KQkq - 1 3")

move_gen = MoveGenerator(board)
print(f"Checkmate: {move_gen.is_checkmate()}")  # True

# Пат
board.load_fen("7k/8/8/8/8/8/8/K6Q b - - 0 1")
print(f"Stalemate: {move_gen.is_stalemate()}")  # True
```

## Ограничения

- Глубина поиска ограничена (~6-8 полуходов в разумное время)
- Нет открывающей книги
- Нет эндшпильных таблиц
- Базовая оценочная функция (можно улучшить)

## Возможные улучшения

1. **Поиск**:
   - Iterative deepening
   - Транспозиционная таблица
   - Killer moves heuristic
   - History heuristic

2. **Оценка**:
   - Более сложные позиционные факторы
   - Оценка безопасности короля
   - Оценка структуры пешек
   - Фазы игры (дебют/миттельшпиль/эндшпиль)

3. **Дополнительно**:
   - Открывающая книга
   - Эндшпильные таблицы (Syzygy)
   - Многопоточность
   - Оптимизация с битбордами

## Лицензия

MIT License

## Автор

AI Chess Developer
